<mvc:View 
    controllerName="com.invertions.sapfiorimodinv.controller.investments.Investments"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:l="sap.ui.layout" 
    xmlns:f="sap.ui.layout.form" 
    xmlns:core="sap.ui.core"
    xmlns:viz="sap.viz.ui5.controls"
    xmlns:viz.data="sap.viz.ui5.data"
    xmlns:viz.feeds="sap.viz.ui5.controls.common.feeds"
    displayBlock="true">

    <Page id="investmentsPage" title="{i18n>investmentsPageTitle}" showHeader="true">
        <headerContent>
            <core:Fragment fragmentName="com.invertions.sapfiorimodinv.view.investments.fragments.SymbolSelector" type="XML"/>
            <ToolbarSpacer/>
            <Text text="{= 'Balance: $' + ${strategyAnalysisModel>/balance}}"
                class="balance sapUiSmallMarginBegin"/>
        </headerContent>

        <content>
            <VBox class="sapUiResponsivePadding">            
                <!-- Navigation Bar -->
                <OverflowToolbar>
                    <IconTabHeader
                        selectedKey="{viewModel>/selectedTab}"
                        select=".onTabSelect"
                        mode="Inline"
                        class="sapUiMediumMarginTopBottom sapUiSizeCozy">
                        <items>
                            <IconTabFilter text="Table" key="table"/>
                            <IconTabFilter text="Chart" key="chart"/>
                        </items>
                    </IconTabHeader>
                    <ToolbarSpacer/>
                    <Button 
                        id="btnHistory"
                        icon="sap-icon://history"
                        tooltip="Historial"
                        press=".onHistoryPress"/>
                </OverflowToolbar>

                <!-- Table View -->
                <VBox visible="{= ${viewModel>/selectedTab} === 'table'}" class="sapUiSmallMarginTop sapUiSmallMarginBegin">
                    <FlexBox renderType="Bare" alignItems="Stretch" justifyContent="Start" width="100%">
                        <!-- Data Table -->
                        <VBox fitContainer="true" width="100%" class="sapUiSmallMarginEnd">
                            <layoutData>
                                <FlexItemData growFactor="1"/>
                            </layoutData>
                            <ScrollContainer height="550px" vertical="true" horizontal="false" width="100%">
                                <Table id="resultsTable"
                                       items="{strategyResultModel>/chart_data}" 
                                       width="100%" 
                                       growing="true" 
                                       growingThreshold="100"
                                       sticky="ColumnHeaders"
                                       busy="{= !${strategyResultModel>/chart_data} || ${strategyResultModel>/chart_data}.length === 0 }"
                                       class="customTable"
                                       >
                                    <headerToolbar>
                                        <OverflowToolbar>
                                            <SearchField
                                                id="tableSearchField"
                                                liveChange=".onTableSearch"
                                                width="300px"
                                                placeholder="Buscar en la tabla..."
                                                showSearchButton="true"
                                                search=".onTableSearch"/>
                                            <ToolbarSpacer/>
                                            <Button
                                                icon="sap-icon://table-column"
                                                tooltip="Personalizar columnas"
                                                press=".openColumnCustomizer"/>
                                        </OverflowToolbar>
                                    </headerToolbar>
                                    <core:Fragment fragmentName="com.invertions.sapfiorimodinv.view.investments.fragments.ColumnCustomizer" type="XML"/>
                                    <columns>
        <Column>
            <Text text="Fecha"/>
        </Column>
        <Column>
            <Text text="Apertura"/>
        </Column>
        <Column>
            <Text text="Máximo"/>
        </Column>
        <Column>
            <Text text="Mínimo"/>
        </Column>
        <Column>
            <Text text="Cierre"/>
        </Column>
        <Column>
            <Text text="Volumen"/>
        </Column>
        <!-- Indicadores separados -->
        <Column>
            <Text text="MA Corta"/>
        </Column>
        <Column>
            <Text text="MA Larga"/>
        </Column>
        <Column>
            <Text text="RSI"/>
        </Column>
        <Column>
            <Text text="SMA"/>
        </Column>
        <Column>
            <Text text="MA"/>
        </Column>
        <Column>
            <Text text="ATR"/>
        </Column>
        <Column>
            <Text text="ADX"/>
        </Column>
        <Column>
            <Text text="Señal"/>
        </Column>
        <Column>
            <Text text="Regla"/>
        </Column>
        <Column>
            <Text text="Acciones"/>
        </Column>
    </columns>
    <items>
        <ColumnListItem>
            <cells>
                <Text text="{strategyResultModel>DATE}"/>
                <Text text="{
                    path: 'strategyResultModel>OPEN',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>HIGH',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>LOW',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>CLOSE',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{strategyResultModel>VOLUME}"/>
                <!-- Indicadores -->
                <Text text="{
                    path: 'strategyResultModel>SHORT_MA',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>LONG_MA',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>RSI',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>SMA',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>MA',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>ATR',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{
                    path: 'strategyResultModel>ADX',
                    formatter: '.formatNumber'
                }"/>
                <Text text="{strategyResultModel>SIGNALS}"/>
                <Text text="{strategyResultModel>RULES}"/>
                <Text text="{strategyResultModel>SHARES}"/>
            </cells>
        </ColumnListItem>
    </items>
                                </Table>
                            </ScrollContainer>
                        </VBox>
                        <!-- Strategy Analysis Panel -->
                        <VBox width="300px" class="sapUiSmallMarginBottom">
                            <core:Fragment id="strategyAnalysisPanelTable" 
                                         fragmentName="com.invertions.sapfiorimodinv.view.investments.fragments.StrategyAnalysisPanel" 
                                         type="XML"/>
                        </VBox>
                    </FlexBox>
                </VBox>

                <!-- Chart View -->
                <VBox visible="{= ${viewModel>/selectedTab} === 'chart'}" class="sapUiSmallMarginTop sapUiSmallMarginBegin">
                    <FlexBox renderType="Bare" alignItems="Stretch" justifyContent="Start" height="auto" width="100%">
                        <!-- Chart Panel -->
                        <VBox fitContainer="true" height="100%" width="100%" class="sapUiSmallMarginEnd">
                            <layoutData>
                                <FlexItemData growFactor="1"/>
                            </layoutData>
                            <Panel headerText="Gráfico de Precios" width="100%" class="sapUiSizeCompact">
                                <headerToolbar>
                                    <OverflowToolbar>
                                        <Title text="Gráfico de Precios"/>
                                        <ToolbarSpacer/>
                                        <Button icon="sap-icon://refresh" 
                                                tooltip="Actualizar datos" 
                                                press=".onRefreshChart"/>
                                    </OverflowToolbar>
                                </headerToolbar>
                                <content>
                                    <viz:VizFrame id="idVizFrame"
                                                 vizType="timeseries_line" 
                                                 width="auto"
                                                 uiConfig="{applicationSet:'fiori'}"
                                                 busy="{= !${strategyResultModel>/chart_data} || ${strategyResultModel>/chart_data}.length === 0 }"
                                                 selectData=".onDataPointSelect">
                                        <viz:dataset>
                                            <viz.data:FlattenedDataset data="{strategyResultModel>/chart_data}">
                                                <viz.data:dimensions>
                                                    <viz.data:DimensionDefinition 
                                                        name="Fecha"
                                                        value="{strategyResultModel>DATE_GRAPH}"
                                                        dataType="date"/>
                                                </viz.data:dimensions>
                                                <viz.data:measures>
                                                    <viz.data:MeasureDefinition
                                                        name="PrecioCierre"
                                                        value="{CLOSE}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="SHORT_MA"
                                                        value="{SHORT_MA}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="LONG_MA"
                                                        value="{LONG_MA}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="RSI"
                                                        value="{RSI}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="SMA"
                                                        value="{SMA}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="MA"
                                                        value="{MA}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="ATR"
                                                        value="{ATR}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="ADX"
                                                        value="{ADX}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="Señal BUY"
                                                        value="{BUY_SIGNAL}"
                                                    />
                                                    <viz.data:MeasureDefinition
                                                        name="Señal SELL"
                                                        value="{SELL_SIGNAL}"
                                                    />
                                                    </viz.data:measures>
                                            </viz.data:FlattenedDataset>
                                        </viz:dataset>
                                        <viz:feeds>
                                            <viz.feeds:FeedItem uid="timeAxis" type="Dimension" values="Fecha"/>
                                            <viz.feeds:FeedItem uid="valueAxis" type="Measure" 
                                                               values="{strategyAnalysisModel>/chartMeasuresFeed}"/>
                                        </viz:feeds>
                                    </viz:VizFrame>
                                </content>
                            </Panel>
                        </VBox>
                        <!-- Strategy Analysis Panel -->
                        <VBox width="300px">
                            <!-- Analysis Panel -->
                            <core:Fragment id="strategyAnalysisPanelChart" 
                                        fragmentName="com.invertions.sapfiorimodinv.view.investments.fragments.StrategyAnalysisPanel" 
                                        type="XML"/>
                            
                            <!-- Results Panel -->
                            <core:Fragment 
                                fragmentName="com.invertions.sapfiorimodinv.view.investments.fragments.StrategyResultPanel" 
                                type="XML"
                                class="sapUiSmallMarginTop"/>
                        </VBox>
                    </FlexBox>
                <!-- Strategy Results -->
                </VBox>
            </VBox>
        </content>
    </Page>
</mvc:View>